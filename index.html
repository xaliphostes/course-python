<!DOCTYPE html>

<head></head>

<body>
    <textarea name="" id="solution" cols="25" rows="6" style="background-color: black; color:#ffffff"></textarea>
    <br /><br /><button id="run"
        style="border-radius: 5px; width: 100px; height: 30px; background-color:rgb(165, 165, 165); color: rgb(0, 0, 0)">Run
        inversion</button>
    <br /><br />
    <div id="myplot" style="border-style: double;border-radius: 5px; width: 500px"></div>

    <script>
        function normalize(n) {
            const l = Math.sqrt(n[0] ** 2 + n[1] ** 2)
            return [n[0] / l, n[1] / l]
        }

        const dot = (n1, n2) => n1[0] * n2[0] + n1[1] * n2[1]

        const lerp = (v0, v1, t) => (1 - t) * v0 + t * v1

        function remoteStress(theta, k) {
            const a = theta * Math.PI / 180.0
            const c = Math.cos(a)
            const s = Math.sin(a)
            const xx = k * s * s
            const xy = k * c * s
            const yy = k * c * c
            const trace = xx + yy
            const discri = Math.sqrt(trace * trace - 4 * (xx * yy - xy * xy))
            // Decreasing order according to the eigen values
            return {
                S1: normalize([xy, (trace + discri) / 2 - xx]),
                S3: normalize([xy, (trace - discri) / 2 - xx])
            }
        }

        const costJoint = (n, eigen) => 1.0 - Math.abs(dot(n, eigen.S3))

        const costStylo = (n, eigen) => 1.0 - Math.abs(dot(n, eigen.S1))

        function mc(data, n) {
            let theta = 0
            let k = 0
            let iter = 0
            let cost = Number.POSITIVE_INFINITY
            for (let i = 0; i < n; ++i) {
                const THETA = lerp(0, 180, Math.random())
                const K = lerp(0, 1, Math.random())
                const remote = remoteStress(THETA, K)
                const c = data.reduce((c, d) => c + d.cost(d.n, remote), 0) / data.length
                if (c < cost) {
                    cost = c
                    theta = THETA
                    k = K
                    iter = i
                }
            }

            document.getElementById('solution').innerHTML = `Solution:
  nb data = ${data.length}
  iter    = ${iter} / ${n}
  theta   = ${theta.toFixed(0)}
  k       = ${k.toFixed(3)}
  cost    = ${cost.toFixed(3)}`
        }

        function generateDomain(data, n) {
            const z = new Array(n * n).fill(0)
            let l = 0
            for (let i = 0; i < n; ++i) {
                const theta = lerp(0, 180, i / (n - 1))
                for (let j = 0; j < n; ++j) {
                    const k = lerp(0, 1, j / (n - 1))

                    const remote = remoteStress(theta, k)
                    z[l++] = data.reduce((c, d) => c + d.cost(d.n, remote), 0) / data.length
                }
            }

            return z
        }

        // -------------------------------------------

        const data = []

        function addData(d, fct) {
            d.forEach(dd => data.push({ n: dd, cost: fct }))
        }
    </script>
    <script>
        const joints = [
            [0.9784027988243839, 0.20670743395585056],
            [0.9783957193693701, 0.20674094011514263],
            [-0.9257498312666042, -0.3781365492911972],
            [-0.9259032923306444, -0.37776062956755213],
            [-0.9221779056082084, -0.38676596335259134],
            [-0.9223156756476181, -0.38643730986367963],
            [-0.9290558842091483, -0.36993940587122837],
            [-0.9288114920771509, -0.3705525768165923],
            [-0.8975062650738317, -0.44100170538584216],
            [-0.897652630432211, -0.44070370440709083],
            [-0.9622856607314592, -0.27204100270109843],
            [-0.9625583575886771, -0.2710745436889789],
            [-0.8841017199440608, -0.46729449899603287],
            [-0.8842381864606932, -0.46703621872902357],
            [-0.8843690889556863, -0.46678829730370214],
            [-0.9260845599839012, -0.37731603167560257],
            [0.8054694394935362, 0.592637310706952],
            [0.8056576951254404, 0.5923813622027309],
            [0.8351192926365588, 0.5500688748386092],
            [0.8348302995836642, 0.5505073758788791],
            [0.9152674495769941, 0.40284673977186974],
            [-0.9806106550217683, -0.19596617886201345],
            [-0.9806106550217681, -0.19596617886201362],
            [-0.9797979010543963, -0.19999018248253997],
            [-0.9799342241629584, -0.19932113865353318],
            [-0.976676257032295, -0.21471723021077324],
            [-0.9768440488117383, -0.21395257488773178],
            [-0.9663809504653751, -0.2571144853516394],
            [-0.966190180747955, -0.25783043774200504],
            [-0.9949449485737809, -0.10042185672211178],
            [-0.9790422363014986, -0.20365730907031204],
            [-0.9952280617956516, 0.09757614982397377],
            [-0.9970335022366876, -0.07696879509024981],
            [-0.9857926692249307, -0.1679667029574211],
            [-0.9766737087875196, -0.21472882098877977],
            [-0.9567556729789698, -0.2908927331896734],
            [-0.9565713421009433, -0.29149831469701537],
            [-0.9382513454391914, -0.34595435071920566],
            [-0.9384792731978375, -0.34533556691725015],
            [-0.9264515210315926, -0.3764141059767138],
            [-0.9599249714282142, -0.2802571127171301],
            [-0.9601000566073639, -0.2796567204673197],
            [-0.9993578629261376, 0.035831017396986464],
            [-0.9993577841009709, -0.03583321583108796],
            [-0.9932503041088764, -0.11599066077760159],
            [-0.9931842738392841, -0.1165547004557693],
            [-0.9997741393923801, -0.021252534018926586],
            [-0.9997539964831721, -0.022179867355903833],
            [-0.9998150743954258, 0.01923062691825564],
            [-0.9961778020506089, -0.08734865025641879],
            [-0.9981893410143803, -0.06015014119083303],
            [-0.9951952009267642, -0.09791073512305656],
            [-0.9989492063107902, -0.04583102891101581],
            [-0.9989123068450005, -0.04662835225053176],
            [-0.9985911012079512, -0.053064230780171875],
            [-0.9954747435576435, -0.09502649598319268],
            [-0.9745003401215215, -0.22438602252154372],
            [-0.9743178354868297, -0.2251771645888167],
            [-0.9701377232831292, -0.24255473168550334],
            [-0.9701377232831293, -0.24255473168550337],
            [-0.976224429995601, -0.21676222521409014],
            [-0.9762222969197643, -0.21677183164954686],
            [-0.9486069369415432, -0.31645675721397226],
            [-0.9486069369415425, -0.3164567572139747],
            [-0.970562449247001, -0.24084960475712416],
            [-0.9734085867379003, -0.2290758024430423],
            [-0.9722493532788151, -0.23394699196383334],
            [-0.9724245975484398, -0.2332174995208442],
            [-0.9373105609056802, -0.34849521146592416],
            [-0.9370856250720987, -0.3490996008064665],
            [-0.956598795910046, -0.2914082079548379],
            [-0.9567783871901202, -0.2908180149266413],
            [-0.9510828962934774, -0.3089357932937045],
            [-0.9508376433015843, -0.3096898062266326],
            [-0.9779568211786525, -0.20880722188215892],
            [-0.9779398236702115, -0.20888681451895388],
            [-0.9919820227219702, -0.12637905916894898],
            [-0.9919820227219701, -0.1263790591689493],
            [-0.937314991621077, -0.34848329440933096],
            [-0.9370692428679841, -0.34914357228914145],
            [-0.9565920471834356, -0.29143036091904323],
            [-0.9567910180565417, -0.2907764566919517],
            [-0.992920543375458, -0.11878044680411706],
            [-0.9960046944368085, -0.0893008883485471],
            [-0.9983188315072379, -0.05796128585550042],
            [-0.9965332541075447, -0.0831953932488319],
            [-0.9965261429723768, -0.0832805281719448],
            [-0.9964355119844677, -0.08435798987797143],
            [-0.9963747581912902, -0.08507256455078889],
            [-0.9868263891199275, 0.16178281038641157],
            [-0.9868199019616216, 0.16182237512920009],
            [-0.9868209658089068, 0.16181588747702252],
            [-0.989205712092078, 0.14653347455242044],
            [-0.9971872531190754, 0.07495053179820076],
            [-0.9998124131125002, 0.019368494679744473],
            [-0.9835707983812606, 0.1805228090066448],
            [-0.9835637125385589, 0.18056141165090372],
            [-0.9486484035550428, 0.3163324302572672],
            [-0.9786362561610817, 0.2055993145100962],
            [-0.990249566303758, 0.13930468920757494],
            [0.9948718286032883, -0.10114368320142063],
            [-0.9947455308014336, -0.10237836173027065],
            [-0.994745965618539, -0.10237413680046584],
            [-0.994387763664305, -0.10579685947466506],
            [-0.9943878429524967, -0.10579611423998897],
            [-0.9903412172432707, -0.13865162613224855],
            [-0.990443760516849, -0.13791721159174622],
            [-0.9721483814304597, -0.2343662187307235],
            [-0.989357279146937, -0.1455066122173481],
            [-0.9854095511493772, -0.17019993097408398],
            [-0.9854094234522389, -0.17020067030281077],
            [-0.896742170638398, -0.44255336333456385],
            [-0.89672947357145, -0.44257909036495363],
            [-0.955413056683379, -0.2952725708881924],
            [-0.9578536722357693, -0.28725657970610746],
            [-0.9843141005223617, -0.17642491749425368],
            [-0.9782409395629009, -0.20747208044238805],
            [-0.9369325370520443, -0.3495102588096945],
            [-0.9536425382704656, -0.3009417039910942],
            [-0.9545293409593362, -0.2981169858423625],
            [-0.9723214976025948, -0.23364696723871048],
            [-0.9723555173834587, -0.23350534857674327],
            [-0.798762325790746, -0.6016466960744971],
            [-0.7888135356324023, -0.6146325780522123],
            [-0.8280375834456758, -0.5606725964423849],
            [-0.8280771777217071, -0.560614116604686],
            [-0.8388209300246926, -0.5444074277161453],
            [-0.8391183673216556, -0.5439488630592391],
            [-0.9105299202341592, -0.41344318153571674],
            [-0.7227248862316329, -0.6911358323958274],
            [-0.8220400667032993, -0.5694296521383789],
            [-0.8391361422633996, -0.5439214417057847],
            [-0.8388198049937122, -0.5444091611557529],
            [-0.9409174237016386, -0.33863609047865983],
            [-0.841108091027928, -0.5408670624167778],
            [-0.8896950220876061, -0.4565553281613675],
            [-0.8907176615201998, -0.45455697932820993],
            [-0.9026265801521745, -0.43042450766980045],
            [-0.9438532309089636, -0.33036506852679043],
            [-0.9412731823129568, -0.33764596289373805],
            [-0.8977276463577676, -0.4405508744344323],
            [-0.9439813801010082, -0.329998718213565],
            [-0.9436408158373101, -0.3309713139924606],
            [-0.900406042975906, -0.4350505232412337],
            [-0.9004060429759054, -0.4350505232412346],
            [-0.9004005406721749, -0.4350619109474595],
            [-0.887177701333916, -0.46142792097560464],
            [-0.8866336795563012, -0.46247239731302253],
            [-0.8866336795563013, -0.4624723973130218],
            [-0.9507796422123934, -0.3098678298153478],
            [-0.9509826350430561, -0.3092442850669445],
            [-0.9193634504307465, -0.39340926020122147],
            [-0.9370691557738486, -0.34914380604170314],
            [-0.9077847384523592, -0.41943637018382407],
            [-0.8976118072331862, -0.4407868458967135],
            [-0.8413591619013445, -0.540476420100514],
            [-0.8539888445510389, -0.5202913158821523],
            [-0.761529995845906, -0.6481296671399438],
            [-0.7609947591420718, -0.6487580261995223],
            [-0.8566624458033922, -0.5158773632852581],
            [-0.9321077431193807, -0.36218110831032385],
            [-0.9260679446943971, -0.3773568096768566],
            [-0.8436382179311881, -0.5369120572737114],
            [-0.8902000541380652, -0.45556982298280674],
            [-0.7804839501181059, -0.6251758181568108],
            [-0.9505160213350043, -0.31067554326897645],
            [-0.9480511520204246, -0.3181179233440732],
            [-0.9063786852867438, -0.42246618664441504],
            [-0.9061169809980373, -0.42302720568186003],
            [-0.8937770621229619, -0.4485114973140012],
            [-0.8937770621229619, -0.4485114973140012],
            [-0.8957217904121118, -0.44461497296078684],
            [0.6581445156574842, 0.7528916233495864],
            [0.777820512829704, 0.628486475448228],
            [0.8143021693579392, 0.5804411916628197],
            [0.6658953047262409, 0.7460452018098815],
            [0.665915506016162, 0.7460271703143517],
            [0.8273300767642409, 0.5617160706987788],
            [0.84313649063177, 0.5376995984424233],
            [-0.7304694569345248, -0.6829453656668155],
            [-0.7301110182385003, -0.6833285454645813],
            [-0.6906120396373236, -0.7232254217793895],
            [-0.9662535804737861, -0.25759273712895825],
            [-0.9741279683387271, -0.22599712675223066],
            [-0.9801316627829143, -0.1983479861516114],
            [-0.9801308422637228, -0.1983520406837433],
            [-0.9867179675618631, -0.1624427668152267],
            [-0.9866782355022533, -0.1626839254080137],
            [-0.9866401356661079, -0.16291483263584103],
            [-0.9901122489920243, -0.1402773481213402],
            [-0.9902112218506619, -0.1395769899411054],
            [-0.6795930908332213, -0.7335892794280389],
            [-0.6796016273094678, -0.7335813711909016],
            [-0.7754064622028856, -0.6314624441516734],
            [-0.8473497990003218, -0.5310351383233639],
            [-0.8473665380496362, -0.5310084276108755],
            [-0.9910943145918271, -0.1331617797408721],
            [-0.9879349038710683, -0.15486970560204222],
            [-0.9836467549529281, -0.1801084714014705],
            [-0.9906517962678887, -0.13641487657585397],
            [-0.9811091578480983, -0.19345495699670107],
            [-0.9581203229517025, -0.2863659315402674],
            [-0.979284510394348, -0.20248912983590497],
            [-0.9383048939469637, -0.3458090889424068],
            [-0.9166655701129434, -0.3996551420531362],
            [-0.9164503035218408, -0.40014852389422356],
            [-0.9008899663272164, -0.43404754183262795],
            [-0.9008507680561643, -0.4341288906449544],
            [-0.9007881485265729, -0.4342588070195801],
            [-0.9332873137784983, -0.35913060290111015],
            [-0.9332095536255005, -0.35933261614010775],
            [-0.9397106183981497, 0.3419706912438071],
            [-0.9462263181791367, 0.3235054169332485],
            [-0.9726647969664433, 0.23221367905923965],
            [-0.9726724199309994, 0.23218174671057476],
            [-0.9878220197673097, -0.15558810128937586],
            [-0.9878224293289678, -0.15558550097813198],
            [-0.977232273360686, -0.2121722976788097],
            [-0.9695424085784369, -0.24492349411177994],
            [0.9505635890003514, 0.31052997160784807],
            [0.9776894832860271, 0.21005540762356315],
            [-0.9815698448905311, -0.19110374041755057],
            [-0.9788892776973138, -0.2043912473889995],
            [-0.973916099400679, -0.22690842057571778],
            [-0.9618103381130998, -0.2737167760638075],
            [-0.9618188193257824, -0.27368697227080074],
            [-0.9275375791031636, -0.3737299016020027],
            [-0.9217263184389028, -0.38784093891319166],
            [-0.965023516949446, -0.2621633302628773],
            [-0.9448142857562641, -0.32760641848242317]
        ]

        const stylolites = [
            [0.22768462857327335, 0.9737349279508518],
            [0.16252455741633695, 0.9867044989441489],
            [0.26020424412919024, -0.9655535983761631],
            [0.2602042441291906, -0.9655535983761631],
            [0.25252512366500135, -0.967590337858939],
            [0.25252512366500135, -0.967590337858939],
            [0.17758060707201626, -0.984106258486315],
            [0.1772557577887311, -0.9841648217299491],
            [0.35471820951198624, -0.9349732572863305],
            [0.3362578250873455, -0.9417699692958617],
            [0.38642679252847606, -0.9223200821928114],
            [-0.19010645514426425, -0.9817634825722953],
            [-0.105027360738252, -0.994469332607274],
            [-0.10419439298216797, -0.9945569508434787],
            [0.11485226958751399, -0.9933825829812988],
            [0.1156336264944622, -0.9932919331313121],
            [0.030601889621851043, -0.9995316525010961],
            [0.03128658216496284, -0.9995104550610939],
            [-0.19819437118782907, -0.9801627371153532],
            [-0.19880590644592466, -0.9800388826787507],
            [-0.02101839751209001, -0.9997790890821951],
            [-0.02022225614691704, -0.999795509269935],
            [-0.1510869789692807, -0.9885204726185168],
            [-0.1511326868670135, -0.9885134854721797],
            [0.6606618865828069, -0.750683602869309],
            [0.6770645369173837, -0.7359236460726404],
            [0.6138135734414498, -0.7894510099170423],
            [0.6164218594316583, -0.7874160851892834],
            [-0.7070194163820063, 0.7071941351982828],
            [-0.6618481132775559, 0.7496379625865673],
            [-0.6614384595353417, 0.7499994428314689],
            [-0.2545331463751184, -0.9670640503071047],
            [-0.36436445610570295, -0.9312564325290835],
            [-0.27456164348397966, -0.9615695003104956],
            [-0.31620789948260997, -0.9486899199974645],
            [-0.2418671623647216, -0.9703093711644949],
            [-0.29699919294883875, -0.9548777300721483],
            [-0.2971333349541831, -0.954835997048187],
            [-0.3912053193218383, -0.9203034272099058],
            [-0.39107416524381333, -0.9203591675421366],
            [0.07478164875747244, -0.9971999323150368],
            [0.07478164875747251, -0.9971999323150368]
        ]
    </script>

    <script type="module">
        import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm"

        addData(joints, costJoint)
        addData(stylolites, costStylo)

        let plot = undefined

        function run() {
            console.log('running')
            // Perform the inversion in order to display the solution
            mc(data, 10000)

            // Compute the domain...
            const values = generateDomain(data, 50)

            // ... and plot it
            const plot = Plot.plot({
                color: { label: "Cost", legend: true },
                marks: [
                    Plot.raster(values, {
                        width: 50, height: 50,
                        x1: 0, x2: 1, y1: 0, y2: 180
                    })
                ]
            })

            document.querySelector("#myplot").innerHTML = ""
            document.querySelector("#myplot").append(plot)
        }

        // Perform the inversion in order to display the solution
        mc(data, 10000)

        // Compute the domain...
        const values = generateDomain(data, 50)

        // ... and plot it
        plot = Plot.plot({
            color: { label: "Cost domain", legend: true },
            marks: [
                Plot.raster(values, {
                    width: 50, height: 50,
                    x1: 0, x2: 1, y1: 0, y2: 180
                })
            ]
        })

        document.querySelector("#myplot").append(plot)
        document.getElementById("run").addEventListener('click', run)
    </script>
</body>